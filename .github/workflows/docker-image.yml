name: Build and Push Docker Images

# Triggers
on:
  push:
    branches:
      - main        # Automatic trigger on push to main branch
  workflow_dispatch: # Manual trigger from GitHub Actions UI

jobs:
  docker:
    runs-on: ubuntu-latest

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      API_IMAGE: kennyl777/snippy-api
      DB_IMAGE: kennyl777/snippy-db

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Extract version from package.json
        id: version
        run: |
          API_VERSION=$(node -p "require('./snippy/backend/package.json').version")
          echo "API_VERSION=$API_VERSION" >> $GITHUB_ENV
          echo "Using API version: $API_VERSION"

          # Optional: if DB has its own package.json
          if [ -f "./snippy/db/package.json" ]; then
            DB_VERSION=$(node -p "require('./snippy/db/package.json').version")
            echo "DB_VERSION=$DB_VERSION" >> $GITHUB_ENV
            echo "Using DB version: $DB_VERSION"
          else
            echo "DB_VERSION=latest" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./snippy/backend
          push: true
          tags: |
            ${{ env.API_IMAGE }}:latest
            ${{ env.API_IMAGE }}:${{ env.API_VERSION }}

      - name: Build and push DB image
        uses: docker/build-push-action@v5
        with:
          context: ./snippy/db
          push: true
          tags: |
            ${{ env.DB_IMAGE }}:latest
            ${{ env.DB_IMAGE }}:${{ env.DB_VERSION }}
