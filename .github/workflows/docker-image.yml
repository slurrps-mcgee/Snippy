name: Build and Deploy

on:
  # push:
  #   branches:
  #     - main
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-deploy:
    if: github.actor == 'slurrps-mcgee' # Only run for specific user
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract version from package.json
      id: version
      shell: bash
      run: |
        # Get API version
        API_VERSION=$(node -p "require('./snippy/backend/package.json').version")
        echo "API_VERSION=$API_VERSION" >> $GITHUB_ENV
        echo "Using API version: $API_VERSION"

        # Get DB version if package.json exists, else default to latest
        if [ -f "./snippy/db/package.json" ]; then
          DB_VERSION=$(node -p "require('./snippy/db/package.json').version")
        else
          DB_VERSION="latest"
        fi
        echo "DB_VERSION=$DB_VERSION" >> $GITHUB_ENV
        echo "Using DB version: $DB_VERSION"

        # Get FrontEnd version
        FE_VERSION=$(node -p "require('./snippy/frontend/package.json').version")
        echo "FE_VERSION=$FE_VERSION" >> $GITHUB_ENV
        echo "Using FE version: $FE_VERSION"

    - name: Build and push API image
      uses: docker/build-push-action@v5
      with:
        context: ./snippy/backend
        push: true
        tags: |
          kennyl777/snippy-api:${{ env.API_VERSION }}
          kennyl777/snippy-api:latest

    - name: Build and push DB image
      uses: docker/build-push-action@v5
      with:
        context: ./snippy/db
        push: true
        tags: |
          kennyl777/snippy-db:${{ env.DB_VERSION }}
          kennyl777/snippy-db:latest

    - name: Build and push FrontEnd image
      uses: docker/build-push-action@v5
      with:
        context: ./snippy/frontend
        push: true
        tags: |
          kennyl777/snippy-frontend:${{ env.FE_VERSION }}
          kennyl777/snippy-frontend:latest
